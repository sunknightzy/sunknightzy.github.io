{"title":"分布式锁的三种实现方案","uid":"109296d43a046ab98a4514702e34310a","slug":"分布式锁的三种实现方案","date":"2017-08-05T05:04:29.000Z","updated":"2019-06-03T04:34:29.000Z","comments":true,"path":"api/articles/分布式锁的三种实现方案.json","keywords":null,"cover":"https://raw.githubusercontent.com/sunknightzy/picsee/main/Picsee/abnerworks.Typora/images-GlLiWS.jpeg","content":"<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>部门最近给我分配了个任务，让我调研一下分布式锁的方案，然后做成组件</p>\n<p>作为一个刚毕业的菜鸟，我表示鸭梨三大，不过没什么是加班搞不定的，冲鸭 ~</p></blockquote>\n<p>考虑在分布式系统中实现锁，通常需要保证互斥性、避免死锁、高可用等特性，Java 实现分布式锁的方案有三种：</p>\n<ol>\n<li>基于 Zookeeper 实现，使用 curator 实现</li>\n<li>基于 Redis 实现，手动实现，或者用 Redisson</li>\n<li>基于数据库 (MySQL) 实现，手动实现</li>\n</ol>\n<h2 id=\"方案对比\"><a href=\"#方案对比\" class=\"headerlink\" title=\"方案对比\"></a>方案对比</h2><table>\n<thead>\n<tr>\n<th align=\"left\">特性</th>\n<th align=\"left\">数据库方案</th>\n<th align=\"left\">Redis方案</th>\n<th align=\"left\">ZooKeeper方案</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\"><strong>性能</strong></td>\n<td align=\"left\">低 (500-1000 TPS)</td>\n<td align=\"left\">高 (10万+ TPS)</td>\n<td align=\"left\">中 (1万+ TPS)</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>实现复杂度</strong></td>\n<td align=\"left\">高</td>\n<td align=\"left\">低</td>\n<td align=\"left\">中</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>可靠性</strong></td>\n<td align=\"left\">依赖数据库稳定性</td>\n<td align=\"left\">依赖Redis集群</td>\n<td align=\"left\">依赖ZooKeeper集群</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>锁释放机制</strong></td>\n<td align=\"left\">需手动&#x2F;超时释放</td>\n<td align=\"left\">自动超时释放</td>\n<td align=\"left\">会话结束自动释放</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>数据一致性</strong></td>\n<td align=\"left\">CP 强一致</td>\n<td align=\"left\">AP 最终一致</td>\n<td align=\"left\">CP 强一致</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>适用场景</strong></td>\n<td align=\"left\">传统企业内部系统</td>\n<td align=\"left\">互联网高并发系统</td>\n<td align=\"left\">金融核心系统</td>\n</tr>\n<tr>\n<td align=\"left\"><strong>故障恢复</strong></td>\n<td align=\"left\">主从切换可能丢锁</td>\n<td align=\"left\">半数节点存活即可服务</td>\n<td align=\"left\">主从切换可能丢锁</td>\n</tr>\n</tbody></table>\n<p><strong>建议</strong>：</p>\n<ul>\n<li>优先选择Redis方案（性能最佳）</li>\n<li>强一致性要求选ZooKeeper</li>\n<li>数据库方案不考虑</li>\n</ul>\n<h2 id=\"方案实现\"><a href=\"#方案实现\" class=\"headerlink\" title=\"方案实现\"></a>方案实现</h2><h3 id=\"基于Zookeeper\"><a href=\"#基于Zookeeper\" class=\"headerlink\" title=\"基于Zookeeper\"></a>基于Zookeeper</h3><h4 id=\"核心机制解析\"><a href=\"#核心机制解析\" class=\"headerlink\" title=\"核心机制解析\"></a>核心机制解析</h4><h5 id=\"锁节点结构\"><a href=\"#锁节点结构\" class=\"headerlink\" title=\"锁节点结构\"></a>锁节点结构</h5><div class=\"language-bash\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">bash</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">[</span><span style=\"color: #EEFFFF\">zk: </span><span style=\"color: #F78C6C\">127.0</span><span style=\"color: #EEFFFF\">.0.1:2181(CONNECTED) </span><span style=\"color: #F78C6C\">23</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #EEFFFF\"> ls /default/payment-lock/pay_id/1000</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">[</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    _c_0c5367c6-f215-45b0-a4e5-db121fcb5fa3-lock-0000000037, </span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    _c_18cad173-4a26-42ba-9bf6-dc3ea2c7c68f-lock-0000000032, </span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    _c_1ad07601-fd65-4dea-bc4b-f43c50535f59-lock-0000000033, </span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    _c_3073654e-21df-44e4-ad5d-e6465e656813-lock-0000000035, </span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    _c_44c85913-6aef-490d-aaec-aa2f3f3c4e67-lock-0000000039, </span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    _c_685522a8-af8e-4aed-bd71-ec45f37d52bc-lock-0000000038, </span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    _c_68f9e57b-6b4f-4d43-b2a5-2b91b4474848-lock-0000000031, </span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    _c_a21693b1-f6f6-4ff9-98a3-17b9c0057f47-lock-0000000034, </span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    _c_bb91efd2-f696-4e98-b41b-3270828e0714-lock-0000000030, </span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    _c_ec3a5b4d-f307-460d-8a97-6eb58f34f58d-lock-0000000036</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">]</span></span></code></pre></div><p>释放锁时，会删除 _c_bb91efd2-f696-4e98-b41b-3270828e0714-lock-0000000030 这样的临时会话顺序节点，但是它们的父节点 &#x2F;pay_id&#x2F;1000 不会被删除。因此，高并发的业务场景下使用 zookeeper 分布式锁时，会留下很多的空节点，存在建立无用节点且多节点之间需要同步数据的问题</p>\n<h5 id=\"加锁流程\"><a href=\"#加锁流程\" class=\"headerlink\" title=\"加锁流程\"></a>加锁流程</h5><ul>\n<li>创建临时有序节点</li>\n<li>获取父节点下所有子节点</li>\n<li>判断当前节点是否序号最小</li>\n<li>若非最小，则监听前一个节点删除事件</li>\n</ul>\n<h5 id=\"解锁流程\"><a href=\"#解锁流程\" class=\"headerlink\" title=\"解锁流程\"></a>解锁流程</h5><ul>\n<li>删除自己创建的临时节点</li>\n<li>触发后续节点的Watcher通知</li>\n</ul>\n<h4 id=\"工作流程\"><a href=\"#工作流程\" class=\"headerlink\" title=\"工作流程\"></a>工作流程</h4><p><img src=\"https://raw.githubusercontent.com/sunknightzy/picsee/main/Picsee/Downloads/zk_lock-ls7Qxl.png\" alt=\"zk_lock\"></p>\n<h4 id=\"实现方案\"><a href=\"#实现方案\" class=\"headerlink\" title=\"实现方案\"></a>实现方案</h4><h5 id=\"Maven-依赖\"><a href=\"#Maven-依赖\" class=\"headerlink\" title=\"Maven 依赖\"></a>Maven 依赖</h5><div class=\"language-xml\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">xml</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #EEFFFF\">  </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">properties</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">maven.compiler.source</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">8</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">maven.compiler.source</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">maven.compiler.target</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">8</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">maven.compiler.target</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">project.build.sourceEncoding</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">UTF-8</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">project.build.sourceEncoding</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #546E7A; font-style: italic\">&lt;!--</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">    Curator 5.0 支持zookeeper3.6.X，不再支持 zookeeper3.4.X</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">    Curator 4.X 支持zookeeper3.5.X，软兼容3.4.X</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">    Curator 2.X 支持zookeeper3.4.X</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">    --&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">curator.version</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">4.2.0</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">curator.version</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">zookeeper.version</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">3.4.14</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">zookeeper.version</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">  </span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">properties</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">  </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">dependencies</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">dependency</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">      </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">groupId</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">org.apache.curator</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">groupId</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">      </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">artifactId</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">curator-recipes</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">artifactId</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">      </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">version</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">$&#123;curator.version&#125;</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">version</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">      </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">exclusions</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">exclusion</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">          </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">groupId</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">org.apache.zookeeper</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">groupId</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">          </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">artifactId</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">zookeeper</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">artifactId</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">exclusion</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">      </span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">exclusions</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">dependency</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">dependency</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">      </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">groupId</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">org.apache.zookeeper</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">groupId</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">      </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">artifactId</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">zookeeper</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">artifactId</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">      </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">version</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">$&#123;zookeeper.version&#125;</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">version</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">      </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">scope</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">compile</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">scope</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">      </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">exclusions</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">exclusion</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">          </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">groupId</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">org.slf4j</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">groupId</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">          </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">artifactId</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">slf4j-log4j12</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">artifactId</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">exclusion</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">      </span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">exclusions</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">dependency</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">  </span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">dependencies</span><span style=\"color: #89DDFF\">&gt;</span></span></code></pre></div><h5 id=\"配置类\"><a href=\"#配置类\" class=\"headerlink\" title=\"配置类\"></a>配置类</h5><p>写一个 ZookeeperLockProperties 类，专门用于锁配置</p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Data</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">ConfigurationProperties</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #FFCB6B\">prefix</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">lock.zookeeper</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">class</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">ZookeeperLockProperties</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> addr </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">localhost:2181</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> namespace </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">default</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> sessionTimeout </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">6000</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> connectionTimeout </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">3000</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> maxRetries </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> retryInterval </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">1000</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> maxSleepTime </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">1000</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">&#125;</span></span></code></pre></div><div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Configuration</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">EnableConfigurationProperties</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">ZookeeperLockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">class</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">class</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">ZookeeperLockConfig</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Bean</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #FFCB6B\">initMethod</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">start</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">destroyMethod</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">close</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">CuratorFramework</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">curatorFramework</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">ZookeeperLockProperties</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockProperties</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">RetryPolicy</span><span style=\"color: #EEFFFF\"> retryPolicy </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">ExponentialBackoffRetry</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getRetryInterval</span><span style=\"color: #89DDFF\">(),</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                lockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getMaxRetries</span><span style=\"color: #89DDFF\">(),</span><span style=\"color: #EEFFFF\"> lockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getMaxSleepTime</span><span style=\"color: #89DDFF\">());</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> CuratorFrameworkFactory</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">builder</span><span style=\"color: #89DDFF\">()</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">connectString</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getAddr</span><span style=\"color: #89DDFF\">())</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">                </span><span style=\"color: #546E7A; font-style: italic\">// 会话超时时间</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">sessionTimeoutMs</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getSessionTimeout</span><span style=\"color: #89DDFF\">())</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">                </span><span style=\"color: #546E7A; font-style: italic\">// 连接超时时间</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">connectionTimeoutMs</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getConnectionTimeout</span><span style=\"color: #89DDFF\">())</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">zk34CompatibilityMode</span><span style=\"color: #89DDFF\">(true)</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">retryPolicy</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">retryPolicy</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">                </span><span style=\"color: #546E7A; font-style: italic\">// 命名空间隔离</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">namespace</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getNamespace</span><span style=\"color: #89DDFF\">())</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">build</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">&#125;</span></span></code></pre></div><h5 id=\"分布式锁实现\"><a href=\"#分布式锁实现\" class=\"headerlink\" title=\"分布式锁实现\"></a>分布式锁实现</h5><div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Component</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">RequiredArgsConstructor</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">class</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">ZookeeperLock</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">final</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">CuratorFramework</span><span style=\"color: #EEFFFF\"> curatorFramework</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">    /**</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * 获取分布式锁（阻塞式）</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     *</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * </span><span style=\"color: #F78C6C; font-style: italic\">@param</span><span style=\"color: #546E7A; font-style: italic\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockPath</span><span style=\"color: #546E7A; font-style: italic\">       锁路径（格式：/lock/resource_name）</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * </span><span style=\"color: #F78C6C; font-style: italic\">@param</span><span style=\"color: #546E7A; font-style: italic\"> </span><span style=\"color: #EEFFFF; font-style: italic\">maxWaitSeconds</span><span style=\"color: #546E7A; font-style: italic\"> 最大等待时间</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     */</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">boolean</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">acquireLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockPath</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">maxWaitSeconds</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">throws</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">Exception</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">InterProcessMutex</span><span style=\"color: #EEFFFF\"> lock </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">InterProcessMutex</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">curatorFramework</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> lockPath</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">acquire</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">maxWaitSeconds</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> TimeUnit</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">SECONDS</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">    /**</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * 释放分布式锁</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     *</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * </span><span style=\"color: #F78C6C; font-style: italic\">@param</span><span style=\"color: #546E7A; font-style: italic\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockPath</span><span style=\"color: #546E7A; font-style: italic\"> 锁路径</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     */</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">void</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">releaseLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockPath</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">throws</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">Exception</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">InterProcessMutex</span><span style=\"color: #EEFFFF\"> lock </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">InterProcessMutex</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">curatorFramework</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> lockPath</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">isAcquiredInThisProcess</span><span style=\"color: #89DDFF\">())</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">release</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">    /**</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * 非阻塞尝试获取锁</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     *</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * </span><span style=\"color: #F78C6C; font-style: italic\">@return</span><span style=\"color: #546E7A; font-style: italic\"> true=获取成功</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     */</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">boolean</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">tryLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockPath</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">throws</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">Exception</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">InterProcessMutex</span><span style=\"color: #EEFFFF\"> lock </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">InterProcessMutex</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">curatorFramework</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> lockPath</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">        </span><span style=\"color: #546E7A; font-style: italic\">// 立即返回</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">acquire</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">null);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">&#125;</span></span></code></pre></div><h5 id=\"使用方式\"><a href=\"#使用方式\" class=\"headerlink\" title=\"使用方式\"></a>使用方式</h5><div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Service</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">RequiredArgsConstructor</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">class</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">Usage</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">static</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">final</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> PAYMENT_LOCK </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">/payment-lock/pay_id/</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">final</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">ZookeeperLock</span><span style=\"color: #EEFFFF\"> lock</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">Boolean</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">processPayment</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">txId</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF; font-style: italic\">try</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> lockKey </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> PAYMENT_LOCK </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #EEFFFF\"> txId</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">acquireLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lockKey</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">5</span><span style=\"color: #89DDFF\">))</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">                </span><span style=\"color: #546E7A; font-style: italic\">// 核心处理逻辑（保证事务唯一性）</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                Thread</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">sleep</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F78C6C\">1000</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> Boolean</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">TRUE</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> Boolean</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">FALSE</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">catch</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">Exception</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">e</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> Boolean</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">FALSE</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">finally</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">try</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">releaseLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">PAYMENT_LOCK</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF\">&#125;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">catch</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">Exception</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">ex</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">                </span><span style=\"color: #546E7A; font-style: italic\">// 记录日志</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">&#125;</span></span></code></pre></div><h5 id=\"关键特性说明\"><a href=\"#关键特性说明\" class=\"headerlink\" title=\"关键特性说明\"></a>关键特性说明</h5><p><strong>性能优化</strong>：</p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">// 关闭不必要的Watcher</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">InterProcessMutex</span><span style=\"color: #EEFFFF\"> lock </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">InterProcessMutex</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">client</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> path</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">StandardLockInternalsDriver</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Override</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">PredicateResults</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">getsTheLock</span><span style=\"color: #89DDFF\">(...,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">List</span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #C792EA\">String</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">children</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">throws</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">Exception</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">            </span><span style=\"color: #546E7A; font-style: italic\">// 自定义获取锁逻辑</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;);</span></span></code></pre></div><p><strong>监控指标</strong>：</p>\n<ul>\n<li>zookeeper.znode.count 监控节点数量</li>\n<li>zookeeper.watch.count 监控Watcher数量</li>\n<li>zookeeper.avg_latency 监控集群延迟</li>\n</ul>\n<p><strong>优点：</strong></p>\n<ul>\n<li>🔒 <strong>强一致性</strong>：基于ZAB协议，保证分布式场景下锁状态一致性</li>\n<li>🚨 <strong>无死锁风险</strong>：临时节点自动删除（客户端断开即释放）</li>\n<li>🔍 <strong>精确唤醒</strong>：Watcher机制避免Redis方案中的无效轮询</li>\n<li>🛡️ <strong>高可靠性</strong>：适合金融、交易等强一致性场景</li>\n</ul>\n<p><strong>建议</strong>：</p>\n<ul>\n<li>对数据一致性要求极高的场景（如支付核心）选择ZooKeeper</li>\n<li>高并发读多写少场景（如商品查询）选择Redis方案</li>\n<li>关键业务建议双方案结合：ZooKeeper做主锁，Redis做缓存锁降级</li>\n</ul>\n<h3 id=\"基于Redis\"><a href=\"#基于Redis\" class=\"headerlink\" title=\"基于Redis\"></a>基于Redis</h3><h4 id=\"核心机制解析-1\"><a href=\"#核心机制解析-1\" class=\"headerlink\" title=\"核心机制解析\"></a>核心机制解析</h4><h5 id=\"加锁流程-1\"><a href=\"#加锁流程-1\" class=\"headerlink\" title=\"加锁流程\"></a>加锁流程</h5><ol>\n<li>根据业务标识 key 查询 value<ol>\n<li>如果 value 不存在说明锁没有被持有，可以直接加锁；</li>\n<li>如果 value 存在，且和自己的线程标识相等，则说明当线程前持锁；</li>\n<li>如果 value 存在，且和自己的线程标识不一样，说明锁正在被其它线程持有</li>\n</ol>\n</li>\n<li>加锁需要创建一个代表业务标识的 key ，value 存放线程标识，需要设置过期时间来预防死锁</li>\n<li>创建一个 watchdog 后台运行，及时给锁续期</li>\n</ol>\n<h5 id=\"解锁流程-1\"><a href=\"#解锁流程-1\" class=\"headerlink\" title=\"解锁流程\"></a>解锁流程</h5><ol>\n<li>根据业务标识 key 查询 value<ol>\n<li>value 和自己的线程标识一样，可以解锁</li>\n<li>value 和自己的线程标识不一样，说明已经自动解锁，并且锁被其它线程持有，无需解锁直接返回（有看门狗的存在，几乎不会发生这种情况）</li>\n</ol>\n</li>\n<li>解锁需要删除自己的业务标识 key ，并且关闭自己开启的 watchdog</li>\n</ol>\n<h4 id=\"工作流程-1\"><a href=\"#工作流程-1\" class=\"headerlink\" title=\"工作流程\"></a>工作流程</h4><p><img src=\"https://raw.githubusercontent.com/sunknightzy/picsee/main/Picsee/Downloads/Redisson_lock-t7PGvM.png\" alt=\"Redisson_lock\"></p>\n<h4 id=\"实现方案-1\"><a href=\"#实现方案-1\" class=\"headerlink\" title=\"实现方案\"></a>实现方案</h4><h5 id=\"Maven-依赖-1\"><a href=\"#Maven-依赖-1\" class=\"headerlink\" title=\"Maven 依赖\"></a>Maven 依赖</h5><div class=\"language-xml\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">xml</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">dependency</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">groupId</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">org.redisson</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">groupId</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">artifactId</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">redisson-spring-boot-starter</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">artifactId</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #F07178\">version</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\">3.18.0</span><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">version</span><span style=\"color: #89DDFF\">&gt;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">&lt;/</span><span style=\"color: #F07178\">dependency</span><span style=\"color: #89DDFF\">&gt;</span></span></code></pre></div><h5 id=\"配置类-1\"><a href=\"#配置类-1\" class=\"headerlink\" title=\"配置类\"></a>配置类</h5><div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Data</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">ConfigurationProperties</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #FFCB6B\">prefix</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">lock.redisson</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">class</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">RedissonLockProperties</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">static</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">final</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> REDIS_PROTO_PREFIX </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">redis://</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">RedisModel</span><span style=\"color: #EEFFFF\"> model </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> RedisModel</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">SINGLETON</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> namespace </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">default</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">RSingleton</span><span style=\"color: #EEFFFF\"> singleton </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">RSingleton</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">RSentinel</span><span style=\"color: #EEFFFF\"> sentinel </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">RSentinel</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">RCluster</span><span style=\"color: #EEFFFF\"> cluster </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">RCluster</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">enum</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">RedisModel</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        SINGLETON</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> SENTINEL</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> CLUSTER</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Data</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">static</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">class</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">RSingleton</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> address </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">localhost:6379</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> password</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> timeout </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">3000</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> pingConnectionInterval </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">60000</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> connectionPoolSize </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">64</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> connectionMinimumIdleSize </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">10</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Data</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">static</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">class</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">RSentinel</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">List</span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #C792EA\">String</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\"> addresses </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> Collections</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">singletonList</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">localhost:6379</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">        /**</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">         * 主节点名称</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">         */</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> master</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> password</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> scanInterval </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">2000</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Data</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">static</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">class</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">RCluster</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">List</span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #C792EA\">String</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\"> addresses </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> Collections</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">singletonList</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">localhost:6379</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> password</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> scanInterval </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">2000</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"></span></code></pre></div><div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Configuration</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">EnableConfigurationProperties</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">RedissonLockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">class</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">class</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">RedissonLockConfig</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Bean</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #FFCB6B\">destroyMethod</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">shutdown</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">RedissonClient</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">redissonClient</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">RedissonLockProperties</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">properties</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">Config</span><span style=\"color: #EEFFFF\"> config </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">Config</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF; font-style: italic\">switch</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">properties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getModel</span><span style=\"color: #89DDFF\">())</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">case</span><span style=\"color: #EEFFFF\"> SENTINEL</span><span style=\"color: #89DDFF; font-style: italic\">:</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #C792EA\">RedissonLockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #C792EA\">RSentinel</span><span style=\"color: #EEFFFF\"> sentinelProps </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> properties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getSentinel</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #C792EA\">SentinelServersConfig</span><span style=\"color: #EEFFFF\"> sentinelServersConfig </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> config</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">useSentinelServers</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                sentinelServersConfig</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">setMasterName</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">sentinelProps</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getMaster</span><span style=\"color: #89DDFF\">());</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #C792EA\">List</span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #C792EA\">String</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\"> addresses </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> sentinelProps</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getAddresses</span><span style=\"color: #89DDFF\">().</span><span style=\"color: #82AAFF\">stream</span><span style=\"color: #89DDFF\">()</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                        </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">map</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">e </span><span style=\"color: #C792EA\">-&gt;</span><span style=\"color: #EEFFFF\"> RedissonLockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">REDIS_PROTO_PREFIX </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #EEFFFF\"> e</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                        </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">collect</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">Collectors</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">toList</span><span style=\"color: #89DDFF\">());</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                sentinelServersConfig</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">setSentinelAddresses</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">addresses</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                sentinelServersConfig</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">setScanInterval</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">sentinelProps</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getScanInterval</span><span style=\"color: #89DDFF\">());</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                Optional</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">ofNullable</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">sentinelProps</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getPassword</span><span style=\"color: #89DDFF\">())</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                        </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">ifPresent</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">sentinelServersConfig</span><span style=\"color: #89DDFF; font-style: italic\">::</span><span style=\"color: #EEFFFF\">setPassword</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF; font-style: italic\">break</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">case</span><span style=\"color: #EEFFFF\"> CLUSTER</span><span style=\"color: #89DDFF; font-style: italic\">:</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #C792EA\">ClusterServersConfig</span><span style=\"color: #EEFFFF\"> clusterServersConfig </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> config</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">useClusterServers</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #C792EA\">RedissonLockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #C792EA\">RCluster</span><span style=\"color: #EEFFFF\"> clusterProps </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> properties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getCluster</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #C792EA\">List</span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #C792EA\">String</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\"> addr </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> clusterProps</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getAddresses</span><span style=\"color: #89DDFF\">().</span><span style=\"color: #82AAFF\">stream</span><span style=\"color: #89DDFF\">()</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                        </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">map</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">e </span><span style=\"color: #C792EA\">-&gt;</span><span style=\"color: #EEFFFF\"> RedissonLockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">REDIS_PROTO_PREFIX </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #EEFFFF\"> e</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                        </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">collect</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">Collectors</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">toList</span><span style=\"color: #89DDFF\">());</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                clusterServersConfig</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">setNodeAddresses</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">addr</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                clusterServersConfig</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">setScanInterval</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">clusterProps</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getScanInterval</span><span style=\"color: #89DDFF\">());</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                Optional</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">ofNullable</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">clusterProps</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getPassword</span><span style=\"color: #89DDFF\">())</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                       </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">ifPresent</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">clusterServersConfig</span><span style=\"color: #89DDFF; font-style: italic\">::</span><span style=\"color: #EEFFFF\">setPassword</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF; font-style: italic\">break</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">default:</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #C792EA\">RedissonLockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #C792EA\">RSingleton</span><span style=\"color: #EEFFFF\"> singletonProps </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> properties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getSingleton</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> address </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> RedissonLockProperties</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">REDIS_PROTO_PREFIX </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #EEFFFF\"> singletonProps</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getAddress</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #C792EA\">SingleServerConfig</span><span style=\"color: #EEFFFF\"> singleServerConfig </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> config</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">useSingleServer</span><span style=\"color: #89DDFF\">()</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                        </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">setTimeout</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">singletonProps</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getTimeout</span><span style=\"color: #89DDFF\">())</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                        </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">setPingConnectionInterval</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">singletonProps</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getPingConnectionInterval</span><span style=\"color: #89DDFF\">())</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                        </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">setConnectionPoolSize</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">singletonProps</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getConnectionPoolSize</span><span style=\"color: #89DDFF\">())</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                        </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">setConnectionMinimumIdleSize</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">singletonProps</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getConnectionMinimumIdleSize</span><span style=\"color: #89DDFF\">())</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                        </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">setAddress</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">address</span><span style=\"color: #89DDFF\">).</span><span style=\"color: #82AAFF\">setDatabase</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                Optional</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">ofNullable</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">singletonProps</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getPassword</span><span style=\"color: #89DDFF\">())</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                        </span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">ifPresent</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">singleServerConfig</span><span style=\"color: #89DDFF; font-style: italic\">::</span><span style=\"color: #EEFFFF\">setPassword</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF; font-style: italic\">break</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> Redisson</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">create</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">config</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"></span></code></pre></div><h5 id=\"锁实现\"><a href=\"#锁实现\" class=\"headerlink\" title=\"锁实现\"></a>锁实现</h5><div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Component</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">class</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">RedissonLock</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">final</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">RedissonClient</span><span style=\"color: #EEFFFF\"> redissonClient</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">final</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> namespace</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">RedissonLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">RedissonClient</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">redissonClient</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">RedissonLockProperties</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockProps</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">this.</span><span style=\"color: #EEFFFF\">redissonClient </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> redissonClient</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">this.</span><span style=\"color: #EEFFFF\">namespace </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> lockProps</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getNamespace</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">    /**</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * 尝试获取分布式锁</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     *</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * </span><span style=\"color: #F78C6C; font-style: italic\">@param</span><span style=\"color: #546E7A; font-style: italic\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockKey</span><span style=\"color: #546E7A; font-style: italic\">   锁键</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * </span><span style=\"color: #F78C6C; font-style: italic\">@param</span><span style=\"color: #546E7A; font-style: italic\"> </span><span style=\"color: #EEFFFF; font-style: italic\">waitTime</span><span style=\"color: #546E7A; font-style: italic\">  最大等待时间(秒)</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * </span><span style=\"color: #F78C6C; font-style: italic\">@param</span><span style=\"color: #546E7A; font-style: italic\"> </span><span style=\"color: #EEFFFF; font-style: italic\">leaseTime</span><span style=\"color: #546E7A; font-style: italic\"> 锁持有时间(秒)</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * </span><span style=\"color: #F78C6C; font-style: italic\">@return</span><span style=\"color: #546E7A; font-style: italic\"> true=获取成功</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     */</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">boolean</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">tryLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockKey</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">long</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">waitTime</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">long</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">leaseTime</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> key </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> namespace </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">:</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #EEFFFF\"> lockKey</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">RLock</span><span style=\"color: #EEFFFF\"> lock </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> redissonClient</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">key</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF; font-style: italic\">try</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">            </span><span style=\"color: #546E7A; font-style: italic\">// 尝试加锁：支持等待时间、自动过期时间</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">tryLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">waitTime</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> leaseTime</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> TimeUnit</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">SECONDS</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">catch</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">InterruptedException</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">e</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            Thread</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">currentThread</span><span style=\"color: #89DDFF\">().</span><span style=\"color: #82AAFF\">interrupt</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">false;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">    /**</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * 释放分布式锁</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     *</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * </span><span style=\"color: #F78C6C; font-style: italic\">@param</span><span style=\"color: #546E7A; font-style: italic\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockKey</span><span style=\"color: #546E7A; font-style: italic\"> 锁键</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     */</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">void</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">unlock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockKey</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> key </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> namespace </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">:</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #EEFFFF\"> lockKey</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">RLock</span><span style=\"color: #EEFFFF\"> lock </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> redissonClient</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">key</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">isLocked</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&amp;&amp;</span><span style=\"color: #EEFFFF\"> lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">isHeldByCurrentThread</span><span style=\"color: #89DDFF\">())</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">unlock</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">&#125;</span></span></code></pre></div><h5 id=\"使用方法\"><a href=\"#使用方法\" class=\"headerlink\" title=\"使用方法\"></a>使用方法</h5><div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Service</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">RequiredArgsConstructor</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">class</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">Usage</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">final</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">RedissonLock</span><span style=\"color: #EEFFFF\"> lock</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">static</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">final</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> ORDER_LOCK_PREFIX </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">order_lock:</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">Boolean</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">createOrder</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">orderId</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> lockKey </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> ORDER_LOCK_PREFIX </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #EEFFFF\"> orderId</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF; font-style: italic\">try</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">tryLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lockKey</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">30</span><span style=\"color: #89DDFF\">))</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">                </span><span style=\"color: #546E7A; font-style: italic\">// 核心业务逻辑（保证订单ID幂等性）</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                Thread</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">sleep</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F78C6C\">1000</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> Boolean</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">TRUE</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> Boolean</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">FALSE</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">catch</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">InterruptedException</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">e</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">throw</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">RuntimeException</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">e</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">finally</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">unlock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lockKey</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"></span></code></pre></div><p>Redission 使用的是 hash 类型，key 是锁的名称，field 是客户端 ID，value 是该客户端加锁（可重入）的次数</p>\n<div class=\"language-bash\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">bash</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #FFCB6B\">127.0.0.1:6379&gt;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C3E88D\">type</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C3E88D\">default:order_lock:1000</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">hash</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">127.0.0.1:6379&gt;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C3E88D\">hgetall</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C3E88D\">default:order_lock:1000</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">1</span><span style=\"color: #EEFFFF\">) </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">7faee086-b466-45f7-9e98-361614e19e18:59</span><span style=\"color: #89DDFF\">&quot;</span></span>\n<span class=\"line\"><span style=\"color: #FFCB6B\">2</span><span style=\"color: #EEFFFF\">) </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">1</span><span style=\"color: #89DDFF\">&quot;</span></span></code></pre></div><h5 id=\"关键特性说明-1\"><a href=\"#关键特性说明-1\" class=\"headerlink\" title=\"关键特性说明\"></a>关键特性说明</h5><p><strong>自动续期机制</strong>（看门狗）</p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">// 当leaseTime参数为-1时，启动看门狗（默认30秒续期）</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">tryLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F78C6C\">3</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">-</span><span style=\"color: #F78C6C\">1</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> TimeUnit</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">SECONDS</span><span style=\"color: #89DDFF\">);</span></span></code></pre></div><p><strong>红锁模式</strong>（应对Redis单点故障）</p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #C792EA\">Config</span><span style=\"color: #EEFFFF\"> config1 </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">Config</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">config1</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">useSingleServer</span><span style=\"color: #89DDFF\">().</span><span style=\"color: #82AAFF\">setAddress</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">redis://node1:6379</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">Config</span><span style=\"color: #EEFFFF\"> config2 </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">Config</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">config2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">useSingleServer</span><span style=\"color: #89DDFF\">().</span><span style=\"color: #82AAFF\">setAddress</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">redis://node2:6379</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">RedissonClient</span><span style=\"color: #EEFFFF\"> client1 </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> Redisson</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">create</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">config1</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">RedissonClient</span><span style=\"color: #EEFFFF\"> client2 </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> Redisson</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">create</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">config2</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">RLock</span><span style=\"color: #EEFFFF\"> lock1 </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> client1</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">lock</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">RLock</span><span style=\"color: #EEFFFF\"> lock2 </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> client2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">getLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">lock</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">RedissonRedLock</span><span style=\"color: #EEFFFF\"> redLock </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">RedissonRedLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lock1</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> lock2</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">redLock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">lock</span><span style=\"color: #89DDFF\">();</span></span></code></pre></div><p><strong>Redis方案适用于AP系统，满足99%高并发场景需求</strong></p>\n<p>优点：</p>\n<ul>\n<li>⚡️ 高性能（内存操作，10万+ QPS）</li>\n<li>📦 原生支持键过期特性</li>\n<li>🔄 成熟的Redisson客户端提供看门狗自动续期</li>\n<li>🧩 支持红锁（RedLock）多实例部署模式</li>\n</ul>\n<h3 id=\"基于数据库-MySQL\"><a href=\"#基于数据库-MySQL\" class=\"headerlink\" title=\"基于数据库(MySQL)\"></a>基于数据库(MySQL)</h3><h4 id=\"工作流程-2\"><a href=\"#工作流程-2\" class=\"headerlink\" title=\"工作流程\"></a>工作流程</h4><p><img src=\"https://raw.githubusercontent.com/sunknightzy/picsee/main/Picsee/Downloads/database_lock-DGAHCR.png\" alt=\"database_lock\"></p>\n<h4 id=\"实现方案-2\"><a href=\"#实现方案-2\" class=\"headerlink\" title=\"实现方案\"></a>实现方案</h4><h5 id=\"数据库设计\"><a href=\"#数据库设计\" class=\"headerlink\" title=\"数据库设计\"></a>数据库设计</h5><div class=\"language-sql\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">sql</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #F78C6C\">CREATE</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">TABLE</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">distributed_lock</span><span style=\"color: #EEFFFF\"> (</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    id </span><span style=\"color: #C792EA\">BIGINT</span><span style=\"color: #EEFFFF\"> AUTO_INCREMENT </span><span style=\"color: #C792EA\">PRIMARY KEY</span><span style=\"color: #EEFFFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    lock_key </span><span style=\"color: #C792EA\">VARCHAR</span><span style=\"color: #EEFFFF\">(</span><span style=\"color: #F78C6C\">128</span><span style=\"color: #EEFFFF\">) </span><span style=\"color: #F78C6C\">NOT NULL</span><span style=\"color: #EEFFFF\"> COMMENT </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">锁标识</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #EEFFFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    holder_id </span><span style=\"color: #C792EA\">VARCHAR</span><span style=\"color: #EEFFFF\">(</span><span style=\"color: #F78C6C\">64</span><span style=\"color: #EEFFFF\">) </span><span style=\"color: #F78C6C\">NOT NULL</span><span style=\"color: #EEFFFF\"> COMMENT </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">持有者标识</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #EEFFFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    expire_time </span><span style=\"color: #F78C6C\">DATETIME</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">NOT NULL</span><span style=\"color: #EEFFFF\"> COMMENT </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">过期时间</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #EEFFFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #F78C6C\">version</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">INT</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">NOT NULL</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">DEFAULT</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">0</span><span style=\"color: #EEFFFF\"> COMMENT </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">乐观锁版本</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #EEFFFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #F78C6C\">UNIQUE</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">INDEX</span><span style=\"color: #EEFFFF\"> uniq_lock_key(lock_key)</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">) ENGINE</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\">InnoDB </span><span style=\"color: #C792EA\">DEFAULT</span><span style=\"color: #EEFFFF\"> CHARSET</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\">utf8mb3;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">-- 初始数据示例</span></span>\n<span class=\"line\"><span style=\"color: #F78C6C\">INSERT INTO</span><span style=\"color: #EEFFFF\"> distributed_lock(lock_key, holder_id, expire_time) </span></span>\n<span class=\"line\"><span style=\"color: #F78C6C\">VALUES</span><span style=\"color: #EEFFFF\"> (</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">order_lock</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #EEFFFF\">, </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">init</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #EEFFFF\">, </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">1970-01-01</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #EEFFFF\">);</span></span></code></pre></div><h5 id=\"锁实现-1\"><a href=\"#锁实现-1\" class=\"headerlink\" title=\"锁实现\"></a>锁实现</h5><div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Component</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">class</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">DatabaseLock</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Autowired</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">JdbcTemplate</span><span style=\"color: #EEFFFF\"> jdbcTemplate</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">  </span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">ThreadLocal</span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #C792EA\">String</span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\"> holderId </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">new</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">ThreadLocal</span><span style=\"color: #89DDFF\">&lt;&gt;();</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #546E7A; font-style: italic\">// 实例唯一标识</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">    /**</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * 尝试获取分布式锁</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * </span><span style=\"color: #F78C6C; font-style: italic\">@param</span><span style=\"color: #546E7A; font-style: italic\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockKey</span><span style=\"color: #546E7A; font-style: italic\"> 锁名称</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * </span><span style=\"color: #F78C6C; font-style: italic\">@param</span><span style=\"color: #546E7A; font-style: italic\"> </span><span style=\"color: #EEFFFF; font-style: italic\">expireSeconds</span><span style=\"color: #546E7A; font-style: italic\"> 锁过期时间(秒)</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * </span><span style=\"color: #F78C6C; font-style: italic\">@param</span><span style=\"color: #546E7A; font-style: italic\"> </span><span style=\"color: #EEFFFF; font-style: italic\">retryTimes</span><span style=\"color: #546E7A; font-style: italic\"> 重试次数</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * </span><span style=\"color: #F78C6C; font-style: italic\">@param</span><span style=\"color: #546E7A; font-style: italic\"> </span><span style=\"color: #EEFFFF; font-style: italic\">retryInterval</span><span style=\"color: #546E7A; font-style: italic\"> 重试间隔(毫秒)</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     */</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">boolean</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">tryLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockKey</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">expireSeconds</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">retryTimes</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">long</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">retryInterval</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF; font-style: italic\">for</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> i </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">;</span><span style=\"color: #EEFFFF\"> i </span><span style=\"color: #89DDFF\">&lt;=</span><span style=\"color: #EEFFFF\"> retryTimes</span><span style=\"color: #89DDFF\">;</span><span style=\"color: #EEFFFF\"> i</span><span style=\"color: #89DDFF\">++)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">acquireLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lockKey</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> expireSeconds</span><span style=\"color: #89DDFF\">))</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">true;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">try</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                Thread</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">sleep</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">retryInterval</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF\">&#125;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">catch</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">InterruptedException</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">e</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                Thread</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">currentThread</span><span style=\"color: #89DDFF\">().</span><span style=\"color: #82AAFF\">interrupt</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">false;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">boolean</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">acquireLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockKey</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">expireSeconds</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        holderId</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">set</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">UUID</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">randomUUID</span><span style=\"color: #89DDFF\">().</span><span style=\"color: #82AAFF\">toString</span><span style=\"color: #89DDFF\">());</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">LocalDateTime</span><span style=\"color: #EEFFFF\"> now </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> LocalDateTime</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">now</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #C792EA\">LocalDateTime</span><span style=\"color: #EEFFFF\"> expireTime </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> now</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">plusSeconds</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">expireSeconds</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">        </span><span style=\"color: #546E7A; font-style: italic\">// 1. 清理过期锁</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        jdbcTemplate</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">update</span><span style=\"color: #89DDFF\">(</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">DELETE FROM distributed_lock WHERE lock_key = ? AND expire_time &lt; ?</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            lockKey</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> now</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">        </span><span style=\"color: #546E7A; font-style: italic\">// 2. 尝试插入新锁记录</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF; font-style: italic\">try</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            jdbcTemplate</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">update</span><span style=\"color: #89DDFF\">(</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">INSERT INTO distributed_lock(lock_key, holder_id, expire_time) VALUES (?, ?, ?)</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                lockKey</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> holderId</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">get</span><span style=\"color: #89DDFF\">(),</span><span style=\"color: #EEFFFF\"> expireTime</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">true;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">catch</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">DuplicateKeyException</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">e</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">            </span><span style=\"color: #546E7A; font-style: italic\">// 3. 已有锁存在时尝试抢占</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> updated </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> jdbcTemplate</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">update</span><span style=\"color: #89DDFF\">(</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">UPDATE distributed_lock SET holder_id = ?, expire_time = ?, version = version + 1 </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">+</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">WHERE lock_key = ? AND (holder_id = ? OR expire_time &lt; ?)</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                holderId</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">get</span><span style=\"color: #89DDFF\">(),</span><span style=\"color: #EEFFFF\"> expireTime</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> lockKey</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> holderId</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">get</span><span style=\"color: #89DDFF\">(),</span><span style=\"color: #EEFFFF\"> now</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> updated </span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">    /**</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     * 释放分布式锁</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">     */</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">void</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">releaseLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #EEFFFF; font-style: italic\">lockKey</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        jdbcTemplate</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">update</span><span style=\"color: #89DDFF\">(</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">DELETE FROM distributed_lock WHERE lock_key = ? AND holder_id = ?</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            lockKey</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> holderId</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        holderId</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">remove</span><span style=\"color: #89DDFF\">();</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">&#125;</span></span></code></pre></div><h5 id=\"使用方式-1\"><a href=\"#使用方式-1\" class=\"headerlink\" title=\"使用方式\"></a>使用方式</h5><div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Service</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">class</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #FFCB6B\">DatabaseLock</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">static</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">final</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> INVENTORY_LOCK </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">inventory_lock</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Autowired</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">private</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">DatabaseLock</span><span style=\"color: #EEFFFF\"> lock</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">Boolean</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">reduceStock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF; font-style: italic\">skuId</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF; font-style: italic\">try</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">            </span><span style=\"color: #546E7A; font-style: italic\">// 尝试获取锁（最多重试3次，每次间隔200ms）</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">tryLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">INVENTORY_LOCK</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">30</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">200</span><span style=\"color: #89DDFF\">))</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">                </span><span style=\"color: #546E7A; font-style: italic\">// 核心减库存逻辑</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">                </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> Boolean</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">TRUE</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #EEFFFF\"> Boolean</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #EEFFFF\">FALSE</span><span style=\"color: #89DDFF\">;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">finally</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">            lock</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">releaseLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">INVENTORY_LOCK</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">&#125;</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">&#125;</span></span></code></pre></div><h5 id=\"关键机制解析\"><a href=\"#关键机制解析\" class=\"headerlink\" title=\"关键机制解析\"></a>关键机制解析</h5><p><strong>双重保险机制</strong>：</p>\n<div class=\"language-sql\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">sql</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">/* 抢占锁的SQL同时处理两种情况 */</span></span>\n<span class=\"line\"><span style=\"color: #F78C6C\">UPDATE</span><span style=\"color: #EEFFFF\"> ... </span></span>\n<span class=\"line\"><span style=\"color: #F78C6C\">WHERE</span><span style=\"color: #EEFFFF\"> lock_key </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> ? </span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">  </span><span style=\"color: #F78C6C\">AND</span><span style=\"color: #EEFFFF\"> (holder_id </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> ?  </span><span style=\"color: #546E7A; font-style: italic\">/* 当前持有者可续期 */</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">       </span><span style=\"color: #F78C6C\">OR</span><span style=\"color: #EEFFFF\"> expire_time </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">NOW</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #546E7A; font-style: italic\">/* 过期锁可抢占 */</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">  )</span></span></code></pre></div><p><strong>死锁预防</strong>：</p>\n<ul>\n<li><p>通过<code>expire_time</code>字段保证锁最终释放</p>\n</li>\n<li><p>后台定时任务清理过期锁：</p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #89DDFF\">@</span><span style=\"color: #C792EA\">Scheduled</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #FFCB6B\">fixedRate</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">60000</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #546E7A; font-style: italic\">// 每分钟清理一次</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">void</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">cleanExpiredLocks</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    jdbcTemplate</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">update</span><span style=\"color: #89DDFF\">(</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">DELETE FROM distributed_lock WHERE expire_time &lt; ?</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        LocalDateTime</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">now</span><span style=\"color: #89DDFF\">().</span><span style=\"color: #82AAFF\">minusMinutes</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F78C6C\">5</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">&#125;</span></span></code></pre></div></li>\n</ul>\n<p><strong>锁续期方案</strong></p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #C792EA\">public</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">void</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #82AAFF\">renewLock</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> lockKey</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #C792EA\">int</span><span style=\"color: #EEFFFF\"> expireSeconds</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&#123;</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    jdbcTemplate</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">update</span><span style=\"color: #89DDFF\">(</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">UPDATE distributed_lock SET expire_time = ? </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">+</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">WHERE lock_key = ? AND holder_id = ?</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        LocalDateTime</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">now</span><span style=\"color: #89DDFF\">().</span><span style=\"color: #82AAFF\">plusSeconds</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">expireSeconds</span><span style=\"color: #89DDFF\">),</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">        lockKey</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #EEFFFF\"> holderId</span></span>\n<span class=\"line\"><span style=\"color: #EEFFFF\">    </span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF\">&#125;</span></span></code></pre></div><p><strong>分库分表</strong>：</p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki material-theme\" style=\"background-color: #263238\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">// 根据 holderId 哈希分库 8个库</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> db </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">db_</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">holderId</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">hashCode</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&amp;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">7</span><span style=\"color: #89DDFF\">);</span></span>\n<span class=\"line\"><span style=\"color: #546E7A; font-style: italic\">// 根据 lock_key 哈希分表 每库 16 个表</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">String</span><span style=\"color: #EEFFFF\"> table </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">distributed_lock_</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #EEFFFF\">lockKey</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">hashCode</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #89DDFF\">&amp;</span><span style=\"color: #EEFFFF\"> </span><span style=\"color: #F78C6C\">15</span><span style=\"color: #89DDFF\">);</span></span></code></pre></div><h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>没有最好的方案，只有最适合的方案，不要过度设计，一切选择要基于实际需求，最终我们还是选择了 Zookeeper 的方案</p>\n<ul>\n<li>我们的保险业务没有高并发的场景</li>\n<li>我们的保险业务需要强一致性</li>\n</ul>\n","feature":true,"text":"文章描述了Java中实现分布式锁的三种方案,以及他们的优缺点...","permalink":"/post/分布式锁的三种实现方案","photos":[],"count_time":{"symbolsCount":"20k","symbolsTime":"18 mins."},"categories":[{"name":"分布式","slug":"分布式","count":2,"path":"api/categories/分布式.json"}],"tags":[{"name":"MySQL","slug":"MySQL","count":2,"path":"api/tags/MySQL.json"},{"name":"Zookeeper","slug":"Zookeeper","count":2,"path":"api/tags/Zookeeper.json"},{"name":"Redis","slug":"Redis","count":2,"path":"api/tags/Redis.json"},{"name":"分布式","slug":"分布式","count":2,"path":"api/tags/分布式.json"},{"name":"分布式锁","slug":"分布式锁","count":1,"path":"api/tags/分布式锁.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94\"><span class=\"toc-text\">方案对比</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0\"><span class=\"toc-text\">方案实现</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%9F%BA%E4%BA%8EZookeeper\"><span class=\"toc-text\">基于Zookeeper</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6%E8%A7%A3%E6%9E%90\"><span class=\"toc-text\">核心机制解析</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E9%94%81%E8%8A%82%E7%82%B9%E7%BB%93%E6%9E%84\"><span class=\"toc-text\">锁节点结构</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E5%8A%A0%E9%94%81%E6%B5%81%E7%A8%8B\"><span class=\"toc-text\">加锁流程</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E8%A7%A3%E9%94%81%E6%B5%81%E7%A8%8B\"><span class=\"toc-text\">解锁流程</span></a></li></ol></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B\"><span class=\"toc-text\">工作流程</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88\"><span class=\"toc-text\">实现方案</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#Maven-%E4%BE%9D%E8%B5%96\"><span class=\"toc-text\">Maven 依赖</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE%E7%B1%BB\"><span class=\"toc-text\">配置类</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0\"><span class=\"toc-text\">分布式锁实现</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F\"><span class=\"toc-text\">使用方式</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E5%85%B3%E9%94%AE%E7%89%B9%E6%80%A7%E8%AF%B4%E6%98%8E\"><span class=\"toc-text\">关键特性说明</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%9F%BA%E4%BA%8ERedis\"><span class=\"toc-text\">基于Redis</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6%E8%A7%A3%E6%9E%90-1\"><span class=\"toc-text\">核心机制解析</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E5%8A%A0%E9%94%81%E6%B5%81%E7%A8%8B-1\"><span class=\"toc-text\">加锁流程</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E8%A7%A3%E9%94%81%E6%B5%81%E7%A8%8B-1\"><span class=\"toc-text\">解锁流程</span></a></li></ol></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B-1\"><span class=\"toc-text\">工作流程</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88-1\"><span class=\"toc-text\">实现方案</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#Maven-%E4%BE%9D%E8%B5%96-1\"><span class=\"toc-text\">Maven 依赖</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE%E7%B1%BB-1\"><span class=\"toc-text\">配置类</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E9%94%81%E5%AE%9E%E7%8E%B0\"><span class=\"toc-text\">锁实现</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95\"><span class=\"toc-text\">使用方法</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E5%85%B3%E9%94%AE%E7%89%B9%E6%80%A7%E8%AF%B4%E6%98%8E-1\"><span class=\"toc-text\">关键特性说明</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%9F%BA%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93-MySQL\"><span class=\"toc-text\">基于数据库(MySQL)</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B-2\"><span class=\"toc-text\">工作流程</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88-2\"><span class=\"toc-text\">实现方案</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1\"><span class=\"toc-text\">数据库设计</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E9%94%81%E5%AE%9E%E7%8E%B0-1\"><span class=\"toc-text\">锁实现</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-1\"><span class=\"toc-text\">使用方式</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E5%85%B3%E9%94%AE%E6%9C%BA%E5%88%B6%E8%A7%A3%E6%9E%90\"><span class=\"toc-text\">关键机制解析</span></a></li></ol></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%80%BB%E7%BB%93\"><span class=\"toc-text\">总结</span></a></li></ol>","author":{"name":"GlassCat","slug":"blog-author","avatar":"/img/avatar.png","link":"/","description":"《论语·为政》<br/>吾尝终日不食，终夜不寝，以思无益，不如学也<br/>--孔子--","socials":{"github":"https://github.com/sunknightzy","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/someaware","csdn":"","juejin":"","customs":{"mail":{"icon":"/svg/mail.svg","link":"mailto:593739859@qq.com"}}}},"mapped":true,"hidden":false,"prev_post":{"title":"分布式ID设计方案","uid":"78eda1e73784e2bed9dff22f7b33de09","slug":"分布式ID设计方案","date":"2017-08-25T05:04:29.000Z","updated":"2019-05-03T08:24:49.000Z","comments":true,"path":"api/articles/分布式ID设计方案.json","keywords":null,"cover":"https://raw.githubusercontent.com/sunknightzy/picsee/main/Picsee/abnerworks.Typora/image-1721273128294-XKUAxI.png","text":"文章描述了Java中实现分布式ID的几种设计方案, 以及他们的优缺点...","permalink":"/post/分布式ID设计方案","photos":[],"count_time":{"symbolsCount":"4.3k","symbolsTime":"4 mins."},"categories":[{"name":"分布式","slug":"分布式","count":2,"path":"api/categories/分布式.json"}],"tags":[{"name":"分布式","slug":"分布式","count":2,"path":"api/tags/分布式.json"},{"name":"分布式ID","slug":"分布式ID","count":1,"path":"api/tags/分布式ID.json"}],"author":{"name":"GlassCat","slug":"blog-author","avatar":"/img/avatar.png","link":"/","description":"《论语·为政》<br/>吾尝终日不食，终夜不寝，以思无益，不如学也<br/>--孔子--","socials":{"github":"https://github.com/sunknightzy","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/someaware","csdn":"","juejin":"","customs":{"mail":{"icon":"/svg/mail.svg","link":"mailto:593739859@qq.com"}}}},"feature":true},"next_post":{}}